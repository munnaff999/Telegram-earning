<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/supabase.js"></script>
  <link rel="stylesheet" href="../css/style.css">

  <style>
    :root{
      --bg:#0f1220; --card:#1b1f3b; --accent:#6a5cff; --text:#fff;
    }
    body.light{
      --bg:#f4f6ff; --card:#fff; --accent:#6a5cff; --text:#111;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif}
    .container{padding:16px;padding-bottom:90px}
    .card{background:var(--card);border-radius:18px;padding:16px;margin-bottom:12px}
    .row{display:flex;align-items:center;gap:12px}
    .avatar{width:64px;height:64px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:22px}
    .btn{background:var(--accent);padding:12px;border-radius:14px;text-align:center;font-weight:600;cursor:pointer}
    .muted{opacity:.7;font-size:13px}
    .top-actions{display:flex;gap:10px}
    .link{color:var(--accent);cursor:pointer}
    .warn{background:#ff980022;border:1px solid #ff9800;border-radius:14px;padding:10px}
    .admin{background:#ff9800;color:#000}
    /* Bottom sheet */
    .sheet{position:fixed;left:0;right:0;bottom:-100%;background:var(--card);border-radius:18px 18px 0 0;padding:16px;transition:.3s}
    .sheet.show{bottom:0}
    .sheet .btn{margin-top:8px}
    /* Slide logout */
    .slide{background:#2a2f5a;border-radius:999px;padding:6px}
    .slider{background:#ff4d4d;width:40%;padding:10px;border-radius:999px;text-align:center}
    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:12px;left:12px;right:12px;background:var(--card);border-radius:30px;display:flex;justify-content:space-around;padding:12px 0}
    .bottom-nav a{color:#aaa;text-decoration:none}
    .bottom-nav a.active{color:var(--accent);font-weight:700}
  </style>
</head>
<body>

<div class="container">

  <!-- Warning banner (UI only) -->
  <div class="warn" id="warn" style="display:none">
    ‚ö†Ô∏è Warning issued on your account. Please follow rules.
  </div>

  <!-- Profile header -->
  <div class="card row">
    <div class="avatar" id="avatar">U</div>
    <div>
      <div id="name">User</div>
      <div class="muted" id="email">email@example.com</div>
      <div class="muted" id="join">Joined: ‚Äî</div>
    </div>
  </div>

  <!-- Balance + Withdraw -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">Balance</div>
        <div id="balance" style="font-size:22px;font-weight:700">‚Çπ0</div>
        <div class="muted" id="minwd">Min withdraw: ‚Äî</div>
      </div>
      <div class="btn" id="withdrawBtn">Withdraw</div>
    </div>
  </div>

  <!-- Quick links -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="link" id="history">üìä Earning history</div>
      <div class="link" id="changePwd">üîê Change password</div>
    </div>
  </div>

  <!-- Settings -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="link" id="langBtn">üåê Language</div>
      <div class="link" id="themeBtn">üåì Theme</div>
    </div>
  </div>

  <!-- Admin -->
  <div class="card admin" id="adminBtn" style="display:none">üëë Admin Panel</div>

  <!-- Slide to logout -->
  <div class="card">
    <div class="muted">Slide to logout</div>
    <div class="slide">
      <div class="slider" id="logout">Logout ‚Üí</div>
    </div>
  </div>

</div>

<!-- Language Sheet -->
<div class="sheet" id="langSheet">
  <h3>Choose language</h3>
  <div class="btn" onclick="setLang('en')">English</div>
  <div class="btn" onclick="setLang('hi')">Hindi</div>
  <div class="btn" onclick="closeSheet()">Close</div>
</div>

<div class="bottom-nav">
  <a href="home.html">Home</a>
  <a href="offers.html">Offers</a>
  <a href="profile.html" class="active">Profile</a>
</div>

<script>
  async function initProfile(){
    await protectPage();
    const p = await getProfile();
    if(!p) return;

    // Basic info
    document.getElementById('name').innerText = p.name || 'User';
    document.getElementById('email').innerText = p.email || '';
    document.getElementById('join').innerText = 'Joined: ' + (p.created_at ? new Date(p.created_at).toDateString() : '‚Äî');
    document.getElementById('balance').innerText = '‚Çπ' + (p.balance || 0);

    // Dynamic min withdraw (placeholder until DB added)
    document.getElementById('minwd').innerText = 'Min withdraw: ‚Çπ' + (p.min_withdraw || 100);

    // Avatar initials
    const initials = (p.name || 'U').slice(0,1).toUpperCase();
    document.getElementById('avatar').innerText = initials;

    // Warning UI (if flagged later)
    if(p.warning) document.getElementById('warn').style.display='block';

    // Admin shortcut
    if(p.role === 'admin'){
      const a = document.getElementById('adminBtn');
      a.style.display='block';
      a.onclick = ()=>location.href='../admin/dashboard.html';
    }
  }

  // Withdraw confirm
  document.getElementById('withdrawBtn').onclick = ()=>{
    if(confirm('Proceed to withdraw?')) location.href='withdraw.html';
  };

  // Links
  document.getElementById('history').onclick = ()=>alert('History page coming next step');
  document.getElementById('changePwd').onclick = ()=>supabase.auth.resetPasswordForEmail(prompt('Enter email'));

  // Language
  const sheet = document.getElementById('langSheet');
  document.getElementById('langBtn').onclick = ()=>sheet.classList.add('show');
  function closeSheet(){ sheet.classList.remove('show'); }
  async function setLang(l){ await setLanguage(l); closeSheet(); }

  // Theme
  document.getElementById('themeBtn').onclick = ()=>{
    document.body.classList.toggle('light');
  };

  // Slide logout (tap)
  document.getElementById('logout').onclick = ()=>logoutUser();

  initProfile();
</script>
</body>
</html>

<!-- Install Button -->
<button onclick="completeOffer(101)">
  Install App â†’ Earn 1 Coin
</button>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================================
   ğŸ”¹ SUPABASE INIT (REAL)
================================ */
const supabase = window.supabase.createClient(
  "https://sqgmfbjllqdbzyfozufy.supabase.co",
  "PASTE_YOUR_PUBLIC_ANON_KEY_HERE"
);

/* ================================
   ğŸ”¹ TELEGRAM LOGIN (PERMANENT)
================================ */
const tg = window.Telegram.WebApp;
tg.expand();

const tgUser = tg.initDataUnsafe?.user;

async function initUser() {
  if (!tgUser) {
    alert("âŒ Please open from Telegram");
    return;
  }

  const telegram_id = tgUser.id;
  const username = tgUser.username || "";

  // Save locally (permanent)
  localStorage.setItem("telegram_id", telegram_id);
  localStorage.setItem("username", username);

  /* ğŸ”¹ Create user ONLY if not exists */
  const { data: existingUser } = await supabase
    .from("users")
    .select("id")
    .eq("telegram_id", telegram_id)
    .maybeSingle();

  if (!existingUser) {
    await supabase.from("users").insert({
      telegram_id: telegram_id,
      username: username,
      balance: 0
    });
  }
}

initUser();

/* ================================
   ğŸ”¹ COMPLETE OFFER (1 COIN)
================================ */
async function completeOffer(offer_id) {
  const telegram_id = localStorage.getItem("telegram_id");
  if (!telegram_id) {
    alert("Telegram login required");
    return;
  }

  // ğŸ”— Redirect to offer
  window.open("https://otieu.com/4/10508140", "_blank");

  /* ğŸ”¹ Check duplicate */
  const { data: alreadyDone } = await supabase
    .from("offer_completions")
    .select("id")
    .eq("telegram_id", telegram_id)
    .eq("offer_id", offer_id)
    .maybeSingle();

  if (alreadyDone) {
    alert("âŒ Offer already completed");
    return;
  }

  /* ğŸ”¹ Get user */
  const { data: user } = await supabase
    .from("users")
    .select("id, balance")
    .eq("telegram_id", telegram_id)
    .single();

  if (!user) {
    alert("User not found");
    return;
  }

  /* ğŸ”¹ Save completion */
  await supabase.from("offer_completions").insert({
    telegram_id: telegram_id,
    offer_id: offer_id,
    reward: 1
  });

  /* ğŸ”¹ Update balance */
  await supabase
    .from("users")
    .update({ balance: user.balance + 1 })
    .eq("id", user.id);

  alert("âœ… 1 Coin Added Successfully");
}
</script>

<!-- Install Button -->
<button onclick="completeOffer(101)">
  Install App ‚Üí Earn 1 Coin
</button>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================================
   üîπ SUPABASE INIT (REAL)
================================ */
const supabase = window.supabase.createClient(
  "https://sqgmfbjllqdbzyfozufy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxZ21mYmpsbHFkYnp5Zm96dWZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMzc4MDgsImV4cCI6MjA4NDcxMzgwOH0.mLzb9BozHyXEG5un9zEfIHIOUhDf0x9iJq6xVh1lIQY"
);

/* ================================
   üîπ TELEGRAM LOGIN (PERMANENT)
================================ */
const tg = window.Telegram.WebApp;
tg.expand();

const tgUser = tg.initDataUnsafe?.user;

async function initUser() {
  if (!tgUser) {
    alert("‚ùå Please open from Telegram");
    return;
  }

  const telegram_id = tgUser.id;
  const username = tgUser.username || "";

  // Save locally (permanent)
  localStorage.setItem("telegram_id", telegram_id);
  localStorage.setItem("username", username);

  /* üîπ Create user ONLY if not exists */
  const { data: existingUser } = await supabase
    .from("users")
    .select("id")
    .eq("telegram_id", telegram_id)
    .maybeSingle();

  if (!existingUser) {
    await supabase.from("users").insert({
      telegram_id: telegram_id,
      username: username,
      balance: 0
    });
  }
}

initUser();

/* ================================
   üîπ COMPLETE OFFER (1 COIN)
================================ */
async function completeOffer(offer_id) {
  const telegram_id = localStorage.getItem("telegram_id");
  if (!telegram_id) {
    alert("Telegram login required");
    return;
  }

  // üîó Redirect to offer
  window.open("https://otieu.com/4/10508140", "_blank");

  /* üîπ Check duplicate */
  const { data: alreadyDone } = await supabase
    .from("offer_completions")
    .select("id")
    .eq("telegram_id", telegram_id)
    .eq("offer_id", offer_id)
    .maybeSingle();

  if (alreadyDone) {
    alert("‚ùå Offer already completed");
    return;
  }

  /* üîπ Get user */
  const { data: user } = await supabase
    .from("users")
    .select("id, balance")
    .eq("telegram_id", telegram_id)
    .single();

  if (!user) {
    alert("User not found");
    return;
  }

  /* üîπ Save completion */
  await supabase.from("offer_completions").insert({
    telegram_id: telegram_id,
    offer_id: offer_id,
    reward: 1
  });

  /* üîπ Update balance */
  await supabase
    .from("users")
    .update({ balance: user.balance + 1 })
    .eq("id", user.id);

  alert("‚úÖ 1 Coin Added Successfully");
}
</script>

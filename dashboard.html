import { auth, db } from "./config.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

import {
  doc,
  getDoc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

/* ELEMENTS */
const loader = document.getElementById("page-loader");
const balanceEl = document.getElementById("balance");
const todayEl = document.getElementById("today");
const totalEl = document.getElementById("total");
const tasksEl = document.getElementById("tasks");
const logoutBtn = document.getElementById("logout");

/* TOAST */
window.showToast = (msg) => {
  const t = document.createElement("div");
  t.className = "toast";
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
};

/* AUTH CHECK */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  try {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      showToast("User record missing");
      return;
    }

    const d = snap.data();

    balanceEl.innerText = "₹" + (d.balance || 0).toFixed(2);
    todayEl.innerText = "₹" + (d.todayEarning || 0).toFixed(2);
    totalEl.innerText = "₹" + (d.totalEarning || 0).toFixed(2);
    tasksEl.innerText = d.completedTasks || 0;

    loader.style.display = "none";

  } catch (e) {
    console.error(e);
    showToast("Dashboard load failed");
  }
});

/* LOGOUT */
logoutBtn.onclick = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

/* TASK CLICK */
document.querySelectorAll(".task-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const reward = parseFloat(btn.dataset.reward);
    const url = btn.dataset.url;

    const user = auth.currentUser;
    if (!user) return;

    window.open(url, "_blank");

    setTimeout(async () => {
      const ref = doc(db, "users", user.uid);
      await updateDoc(ref, {
        balance: increment(reward),
        todayEarning: increment(reward),
        totalEarning: increment(reward),
        completedTasks: increment(1)
      });
      showToast(`₹${reward} added`);
      location.reload();
    }, 30000); // 30 sec
  });
});
